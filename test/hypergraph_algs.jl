import PIPG:hyper_degree, refine_pseudoperipheral

@testset "Matrix sorting" begin     
    I = [2, 5, 9, 10, 4, 9, 3, 7, 9, 10, 6, 7, 2, 1, 3, 8, 2, 5, 7, 4, 9, 10, 1, 2, 3, 1, 2, 5, 8]
    J = [1, 1, 1, 1, 2, 2, 3, 4, 4, 4, 5, 5, 6,7, 7, 7, 8,8,9,10,10,10,11,11,11,12,12,12,12]
    V = ones(Int, length(I))
    B = sparse(I, J, V)

    @test hyper_degree(B, 1) == 4
    @test hyper_degree(B, 2) == 6
    @test hyper_degree(B, 3) == 3
    @test hyper_degree(B, 4) == 2
    @test hyper_degree(B, 5) == 5
    @test hyper_degree(B, 6) == 1
    @test hyper_degree(B, 7) == 3
    @test hyper_degree(B, 8) == 4
    @test hyper_degree(B, 9) == 5
    @test hyper_degree(B, 10) == 5

    @test refine_pseudoperipheral(B, 1)[1] == 6
    @test refine_pseudoperipheral(B, 6)[1] == 1
end


@testset "variables in set" begin 
    socone = PIPG.SOCone{Float64, 2}(1.0)
    @test PIPG.variables(socone) == [1 => 1, 1 => 2]
    halfspace = PIPG.HalfspaceCone{Float64, 2}(ones(2), 1.0)
    @test PIPG.variables(halfspace) == [1 => 1, 1 => 2]
    ptcone = PIPG.PTCone{Float64}((socone, halfspace))
    @test PIPG.variables(ptcone) == [1 => 1, 1 => 2, 2 => 3, 2 => 4]
end

@testset "quadcopter" begin 
    H = sparse([1, 2, 61, 121, 21, 22, 81, 140, 41, 42, 101, 159, 61, 62, 121, 81, 82, 140, 101, 102, 159, 2, 3, 62, 122, 22, 23, 82, 141, 42, 43, 102, 160, 62, 63, 122, 82, 83, 141, 102, 103, 160, 3, 4, 63, 123, 23, 24, 83, 142, 43, 44, 103, 161, 63, 64, 123, 83, 84, 142, 103, 104, 161, 4, 5, 64, 124, 24, 25, 84, 143, 44, 45, 104, 162, 64, 65, 124, 84, 85, 143, 104, 105, 162, 5, 6, 65, 125, 25, 26, 85, 144, 45, 46, 105, 163, 65, 66, 125, 85, 86, 144, 105, 106, 163, 6, 7, 66, 126, 26, 27, 86, 145, 46, 47, 106, 164, 66, 67, 126, 86, 87, 145, 106, 107, 164, 7, 8, 67, 127, 27, 28, 87, 146, 47, 48, 107, 165, 67, 68, 127, 87, 88, 146, 107, 108, 165, 8, 9, 68, 128, 28, 29, 88, 147, 48, 49, 108, 166, 68, 69, 128, 88, 89, 147, 108, 109, 166, 9, 10, 69, 129, 29, 30, 89, 148, 49, 50, 109, 167, 69, 70, 129, 89, 90, 148, 109, 110, 167, 10, 11, 70, 130, 30, 31, 90, 149, 50, 51, 110, 168, 70, 71, 130, 90, 91, 149, 110, 111, 168, 11, 12, 71, 131, 31, 32, 91, 150, 51, 52, 111, 169, 71, 72, 131, 91, 92, 150, 111, 112, 169, 12, 13, 72, 132, 32, 33, 92, 151, 52, 53, 112, 170, 72, 73, 132, 92, 93, 151, 112, 113, 170, 13, 14, 73, 133, 33, 34, 93, 152, 53, 54, 113, 171, 73, 74, 133, 93, 94, 152, 113, 114, 171, 14, 15, 74, 134, 34, 35, 94, 153, 54, 55, 114, 172, 74, 75, 134, 94, 95, 153, 114, 115, 172, 15, 16, 75, 135, 35, 36, 95, 154, 55, 56, 115, 173, 75, 76, 135, 95, 96, 154, 115, 116, 173, 16, 17, 76, 136, 36, 37, 96, 155, 56, 57, 116, 174, 76, 77, 136, 96, 97, 155, 116, 117, 174, 17, 18, 77, 137, 37, 38, 97, 156, 57, 58, 117, 175, 77, 78, 137, 97, 98, 156, 117, 118, 175, 18, 19, 78, 138, 38, 39, 98, 157, 58, 59, 118, 176, 78, 79, 138, 98, 99, 157, 118, 119, 176, 19, 20, 79, 139, 39, 40, 99, 158, 59, 60, 119, 177, 79, 80, 139, 99, 100, 158, 119, 120, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 1, 21, 41, 1, 21, 41, 1, 21, 1, 21, 1, 21, 2, 22, 42, 2, 22, 42, 2, 22, 2, 22, 2, 22, 3, 23, 43, 3, 23, 43, 3, 23, 3, 23, 3, 23, 4, 24, 44, 4, 24, 44, 4, 24, 4, 24, 4, 24, 5, 25, 45, 5, 25, 45, 5, 5, 25, 5, 25, 6, 26, 46, 6, 26, 46, 6, 26, 6, 26, 6, 26, 7, 27, 47, 7, 27, 47, 7, 27, 7, 27, 7, 27, 8, 28, 48, 8, 28, 48, 8, 28, 8, 28, 8, 28, 9, 29, 49, 9, 29, 49, 9, 29, 9, 29, 9, 29, 10, 30, 50, 10, 30, 50, 10, 30, 10, 30, 10, 30, 11, 31, 51, 11, 31, 51, 11, 31, 11, 31, 11, 31, 12, 32, 52, 12, 32, 52, 12, 32, 12, 32, 12, 32, 13, 33, 53, 13, 33, 53, 13, 33, 13, 33, 13, 33, 14, 34, 54, 14, 34, 54, 14, 34, 14, 34, 14, 34, 15, 35, 55, 15, 35, 55, 15, 35, 15, 35, 15, 35, 16, 36, 56, 16, 36, 56, 16, 36, 16, 36, 16, 36, 17, 37, 57, 17, 37, 57, 17, 37, 17, 37, 17, 37, 18, 38, 58, 18, 38, 58, 18, 38, 18, 38, 18, 38, 19, 39, 59, 19, 39, 59, 19, 39, 19, 39, 19, 39, 20, 40, 60, 20, 40, 60, 20, 40, 20, 40, 20, 40, 159, 121, 140, 159, 121, 140, 159, 160, 122, 141, 160, 122, 141, 160, 161, 123, 142, 161, 123, 142, 161, 162, 124, 143, 162, 124, 143, 162, 163, 125, 144, 163, 125, 144, 163, 164, 126, 145, 164, 126, 145, 164, 165, 127, 146, 165, 127, 146, 165, 166, 128, 147, 166, 128, 147, 166, 167, 129, 148, 167, 129, 148, 167, 168, 130, 149, 168, 130, 149, 168, 169, 131, 150, 169, 131, 150, 169, 170, 132, 151, 170, 132, 151, 170, 171, 133, 152, 171, 133, 152, 171, 172, 134, 153, 172, 134, 153, 172, 173, 135, 154, 173, 135, 154, 173, 174, 136, 155, 174, 136, 155, 174, 175, 137, 156, 175, 137, 156, 175, 176, 138, 157, 176, 138, 157, 176, 177, 139, 158, 177, 139, 158, 177, 178, 61, 81, 101, 179, 62, 82, 102, 180, 63, 83, 103, 181, 64, 84, 104, 182, 65, 85, 105, 183, 66, 86, 106, 184, 67, 87, 107, 185, 68, 88, 108, 186, 69, 89, 109, 187, 70, 90, 110, 188, 71, 91, 111, 189, 72, 92, 112, 190, 73, 93, 113, 191, 74, 94, 114, 192, 75, 95, 115, 193, 76, 96, 116, 194, 77, 97, 117, 195, 78, 98, 118, 196, 79, 99, 119, 197, 80, 100, 120], [1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 11, 11, 11, 12, 12, 12, 13, 13, 13, 13, 14, 14, 14, 14, 15, 15, 15, 15, 16, 16, 16, 17, 17, 17, 18, 18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 23, 23, 23, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 27, 27, 27, 27, 28, 28, 28, 29, 29, 29, 30, 30, 30, 31, 31, 31, 31, 32, 32, 32, 32, 33, 33, 33, 33, 34, 34, 34, 35, 35, 35, 36, 36, 36, 37, 37, 37, 37, 38, 38, 38, 38, 39, 39, 39, 39, 40, 40, 40, 41, 41, 41, 42, 42, 42, 43, 43, 43, 43, 44, 44, 44, 44, 45, 45, 45, 45, 46, 46, 46, 47, 47, 47, 48, 48, 48, 49, 49, 49, 49, 50, 50, 50, 50, 51, 51, 51, 51, 52, 52, 52, 53, 53, 53, 54, 54, 54, 55, 55, 55, 55, 56, 56, 56, 56, 57, 57, 57, 57, 58, 58, 58, 59, 59, 59, 60, 60, 60, 61, 61, 61, 61, 62, 62, 62, 62, 63, 63, 63, 63, 64, 64, 64, 65, 65, 65, 66, 66, 66, 67, 67, 67, 67, 68, 68, 68, 68, 69, 69, 69, 69, 70, 70, 70, 71, 71, 71, 72, 72, 72, 73, 73, 73, 73, 74, 74, 74, 74, 75, 75, 75, 75, 76, 76, 76, 77, 77, 77, 78, 78, 78, 79, 79, 79, 79, 80, 80, 80, 80, 81, 81, 81, 81, 82, 82, 82, 83, 83, 83, 84, 84, 84, 85, 85, 85, 85, 86, 86, 86, 86, 87, 87, 87, 87, 88, 88, 88, 89, 89, 89, 90, 90, 90, 91, 91, 91, 91, 92, 92, 92, 92, 93, 93, 93, 93, 94, 94, 94, 95, 95, 95, 96, 96, 96, 97, 97, 97, 97, 98, 98, 98, 98, 99, 99, 99, 99, 100, 100, 100, 101, 101, 101, 102, 102, 102, 103, 103, 103, 103, 104, 104, 104, 104, 105, 105, 105, 105, 106, 106, 106, 107, 107, 107, 108, 108, 108, 109, 109, 109, 109, 110, 110, 110, 110, 111, 111, 111, 111, 112, 112, 112, 113, 113, 113, 114, 114, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 160, 161, 161, 162, 162, 163, 164, 165, 166, 167, 168, 169, 169, 170, 170, 171, 171, 172, 173, 174, 175, 176, 177, 178, 178, 179, 179, 180, 180, 181, 182, 183, 184, 185, 186, 187, 187, 188, 188, 189, 189, 190, 191, 192, 193, 194, 195, 196, 197, 197, 198, 198, 199, 200, 201, 202, 203, 204, 205, 205, 206, 206, 207, 207, 208, 209, 210, 211, 212, 213, 214, 214, 215, 215, 216, 216, 217, 218, 219, 220, 221, 222, 223, 223, 224, 224, 225, 225, 226, 227, 228, 229, 230, 231, 232, 232, 233, 233, 234, 234, 235, 236, 237, 238, 239, 240, 241, 241, 242, 242, 243, 243, 244, 245, 246, 247, 248, 249, 250, 250, 251, 251, 252, 252, 253, 254, 255, 256, 257, 258, 259, 259, 260, 260, 261, 261, 262, 263, 264, 265, 266, 267, 268, 268, 269, 269, 270, 270, 271, 272, 273, 274, 275, 276, 277, 277, 278, 278, 279, 279, 280, 281, 282, 283, 284, 285, 286, 286, 287, 287, 288, 288, 289, 290, 291, 292, 293, 294, 295, 295, 296, 296, 297, 297, 298, 299, 300, 301, 302, 303, 304, 304, 305, 305, 306, 306, 307, 308, 309, 310, 311, 312, 313, 313, 314, 314, 315, 315, 316, 317, 318, 319, 320, 321, 322, 322, 323, 323, 324, 324, 325, 326, 327, 328, 329, 330, 331, 331, 332, 332, 333, 333, 334, 335, 336, 337, 339, 340, 341, 342, 343, 344, 345, 347, 348, 349, 350, 351, 352, 353, 355, 356, 357, 358, 359, 360, 361, 363, 364, 365, 366, 367, 368, 369, 371, 372, 373, 374, 375, 376, 377, 379, 380, 381, 382, 383, 384, 385, 387, 388, 389, 390, 391, 392, 393, 395, 396, 397, 398, 399, 400, 401, 403, 404, 405, 406, 407, 408, 409, 411, 412, 413, 414, 415, 416, 417, 419, 420, 421, 422, 423, 424, 425, 427, 428, 429, 430, 431, 432, 433, 435, 436, 437, 438, 439, 440, 441, 443, 444, 445, 446, 447, 448, 449, 451, 452, 453, 454, 455, 456, 457, 459, 460, 461, 462, 463, 464, 465, 467, 468, 469, 470, 471, 472, 473, 475, 476, 477, 478, 479, 480, 481, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550, 551, 552, 553, 554, 555, 556, 557, 558, 559, 560, 561, 562, 563, 564, 565], [1.010943785031295, -1.010943785031295, 0.25273594625782375, 0.722102703593782, 1.008791867470339, -1.008791867470339, 0.2521979668675848, 0.7205656196216708, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.010943785031295, -1.010943785031295, 0.25273594625782375, 0.722102703593782, 1.0087512863548214, -1.0087512863548214, 0.25218782158870534, 0.7205366331105867, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.009259803451376, -1.009259803451376, 0.252314950862844, 0.7208998596081259, 1.0087512863548214, -1.0087512863548214, 0.25218782158870534, 0.7205366331105867, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.009259803451376, -1.009259803451376, 0.252314950862844, 0.7208998596081259, 1.0140965533005553, -1.0140965533005553, 0.2535241383251388, 0.7243546809289679, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0094596811234247, -1.0094596811234247, 0.25236492028085616, 0.721042629373875, 1.0137414461281569, -1.0137414461281569, 0.2534353615320392, 0.7241010329486833, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0097592855259632, -1.0097592855259632, 0.2524398213814908, 0.7212566325185452, 1.0134939699426546, -1.0134939699426546, 0.25337349248566365, 0.7239242642447535, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.010076445862369, -1.010076445862369, 0.25251911146559225, 0.721483175615978, 1.0133179716193839, -1.0133179716193839, 0.25332949290484597, 0.723798551156703, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0103580719910692, -1.0103580719910692, 0.2525895179977673, 0.7216843371364782, 1.013188792373584, -1.013188792373584, 0.253297198093396, 0.7237062802668457, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0105967098757247, -1.0105967098757247, 0.2526491774689312, 0.7218547927683747, 1.0130909625592641, -1.0130909625592641, 0.25327274063981603, 0.7236364018280459, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.010795058033694, -1.010795058033694, 0.2526987645084235, 0.7219964700240675, 1.0130147815886863, -1.0130147815886863, 0.2532536953971716, 0.7235819868490615, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0109594527883234, -1.0109594527883234, 0.25273986319708086, 0.7221138948488026, 1.0129540203149834, -1.0129540203149834, 0.25323850507874585, 0.7235385859392742, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0110955261325194, -1.0110955261325194, 0.25277388153312985, 0.7222110900946569, 1.0129045575331508, -1.0129045575331508, 0.2532261393832877, 0.7235032553808222, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0112101648719845, -1.0112101648719845, 0.2528025412179961, 0.7222929749085605, 1.0128635841602032, -1.0128635841602032, 0.2532158960400508, 0.7234739886858594, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.011307301177805, -1.011307301177805, 0.2528268252944513, 0.7223623579841465, 1.012829131710178, -1.012829131710178, 0.2532072829275445, 0.7234493797929844, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0113905282991027, -1.0113905282991027, 0.2528476320747757, 0.7224218059279305, 1.0127997857900413, -1.0127997857900413, 0.2531999464475103, 0.7234284184214582, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0114625542574351, -1.0114625542574351, 0.2528656385643588, 0.7224732530410252, 1.0127745071308145, -1.0127745071308145, 0.25319362678270363, 0.723410362236296, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0115254470737498, -1.0115254470737498, 0.25288136176843745, 0.7225181764812497, 1.0127525167076745, -1.0127525167076745, 0.25318812917691863, 0.7233946547911961, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0115808071695596, -1.0115808071695596, 0.2528952017923899, 0.7225577194068283, 1.0127332200849941, -1.0127332200849941, 0.25318330502124853, 0.7233808714892814, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0116298890517326, -1.0116298890517326, 0.25290747226293314, 0.7225927778940945, 1.0127161564005343, -1.0127161564005343, 0.25317903910013356, 0.7233686831432387, 1.0, -1.0, 0.25, 0.7142857142857143, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.356894189436591, -1.356894189436591, 0.9692101353118507, 1.3568942111913096, -1.3568942111913096, 0.9692101508509352, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, 1.0027112750502025, -1.0112619933416402, -1.0159210561134413, -1.0, 1.0112619933416402, 1.0159210561134413, 1.0, 0.2539802640283606, -1.0159210561134413, -0.732389447744091, -1.0159210561134413, -0.7549151136821921, -1.0159210561134413, -1.010943785031295, -1.008791867470339, -1.0, 1.010943785031295, 1.008791867470339, 1.0, 1.010943785031295, 0.8611850606177521, -0.703097362176297, -1.008791867470339, -0.7744947437264958, -1.008791867470339, -1.01099512631533, -1.0087512863548214, -1.0, 1.01099512631533, 1.0087512863548214, 1.0, 1.01099512631533, 0.8511474377090277, -0.6833476455952016, -1.0087512863548214, -0.7588180042667358, -1.0087512863548214, -1.009259803451376, -1.0145931914706336, -1.0, 1.009259803451376, 1.0145931914706336, 1.0, 1.009259803451376, -0.2523149508628441, -0.6744790649532663, -1.0145931914706336, -0.7064243772616196, -1.0145931914706336, -1.0094596811234247, -1.0140965533005553, -1.0, 1.0094596811234247, 1.0140965533005553, 1.0, 1.0094596811234247, -0.7136235004707611, -1.0140965533005553, -0.7436708057537407, -1.0140965533005553, -1.0097592855259632, -1.013741446128157, -1.0, 1.0097592855259632, 1.013741446128157, 1.0, 1.0097592855259632, 0.16829321425432714, -0.7541980359162134, -1.013741446128157, -0.7813423775439885, -1.013741446128157, -1.010076445862369, -1.0134939699426546, -1.0, 1.010076445862369, 1.0134939699426546, 1.0, 1.010076445862369, 0.288593270246391, -0.7889752911189282, -1.0134939699426546, -0.8132019813091049, -1.0134939699426546, -1.0103580719910692, -1.0133179716193836, -1.0, 1.0103580719910692, 1.0133179716193836, 1.0, 1.0103580719910692, 0.37888427699665106, -0.817212251723385, -1.0133179716193836, -0.8388487082692992, -1.0133179716193836, -1.0105967098757247, -1.013188792373584, -1.0, 1.0105967098757247, 1.013188792373584, 1.0, 1.010596709875725, 0.4491540932781002, -0.8399342732371922, -1.013188792373584, -0.8593640385000696, -1.013188792373584, -1.0107950580336942, -1.0130909625592641, -1.0, 1.0107950580336942, 1.0130909625592641, 1.0, 1.0107950580336942, 0.505397529016847, -0.8583433172944759, -1.0130909625592641, -0.8759134413858279, -1.0130909625592641, -1.0109594527883234, -1.0130147815886863, -1.0, 1.0109594527883234, 1.0130147815886863, 1.0, 1.0109594527883234, 0.5514324287936306, -0.8734373415825327, -1.0130147815886863, -0.8894383119126198, -1.0130147815886863, -1.0110955261325194, -1.0129540203149834, -1.0, 1.0110955261325194, 1.0129540203149834, 1.0, 1.0110955261325194, 0.5898057235773027, -0.8859760501351467, -1.0129540203149836, -0.9006448261424604, -1.0129540203149836, -1.0112101648719845, -1.0129045575331508, -1.0, 1.0112101648719845, 1.0129045575331508, 1.0, 1.0112101648719845, 0.6222831783827596, -0.8965246003956949, -1.012904557533151, -0.9100533672821325, -1.0129045575331508, -1.011307301177805, -1.0128635841602032, -1.0, 1.011307301177805, 1.0128635841602032, 1.0, 1.011307301177805, 0.6501261221857318, -0.905503193088467, -1.0128635841602032, -0.9180482556063151, -1.0128635841602032, -1.0113905282991027, -1.0128291317101779, -1.0, 1.0113905282991027, 1.0128291317101779, 1.0, 1.011390528299103, 0.6742603521994016, -0.9132268629460005, -1.0128291317101779, -0.9249161732080426, -1.0128291317101779, -1.011462554257435, -1.0127997857900413, -1.0, 1.011462554257435, 1.0127997857900413, 1.0, 1.0114625542574351, 0.6953805060519868, -0.9199345942322142, -1.0127997857900415, -0.9308737373551518, -1.0127997857900415, -1.01152544707375, -1.0127745071308145, -1.0, 1.01152544707375, 1.0127745071308145, 1.0, 1.01152544707375, 0.7140179626402938, -0.9258100206108282, -1.0127745071308145, -0.9360868648327212, -1.0127745071308145, -1.0115808071695598, -1.0127525167076747, -1.0, 1.0115808071695598, 1.0127525167076747, 1.0, 1.0115808071695598, 0.7305861385113485, -0.9309960640796073, -1.0127525167076747, -0.9406843491857773, -1.0127525167076747, -1.0116298890517326, -1.0127332200849941, -1.0, 1.0116298890517326, 1.0127332200849941, 1.0, 1.0116298890517328, 0.7454114971960133, -0.9356053372888283, -1.0127332200849941, -0.9447674467778899, -1.0127332200849941, -1.011673688002601, -1.0127161564005343, -1.0, 1.011673688002601, 1.0127161564005343, 1.0, 1.011673688002601, 0.7587552660019504, -0.9397276045878832, -1.0127161564005343, -0.9484167178989126, -1.0127161564005343, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027112750502025, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0027081470140051, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754, 1.0, 1.3572098295833754, 1.3572098295833754, 1.3572098295833754], 197, 565)

    (vert_perm, edge_perm) = PIPG.sort_matrix(H, 20)
    @test length(unique(vert_perm)) == length(vert_perm)
    @test length(unique(edge_perm)) == length(edge_perm)
end

@testset "masses" begin 
    t = 20
    l = 32
    x0 = repeat([0.1, 0.0], l)
    Pd = 3*l*t + 2*l
    P = sparse(1.0I, Pd, Pd)
    q = zeros(3*t*l + 2*l)
    Hd = 2*l*t
    L = Tridiagonal(repeat([-1], l-1),repeat([2], l), repeat([-1], l-1))
    Δ = 0.1
    Ac = [zeros(l,l) 1.0I(l); -L zeros(l,l)]
    A = exp(collect(Δ*Ac))
    Bc = [zeros(l,l); 1.0I(l)]
    B = Ac\((A - I(2*l))*Bc)
    H = [([zeros(2*l*t, 2*l) sparse(I, Hd, Hd)]-[kron(I(t), A) zeros(2*l*t, 2*l)]) -kron(I(t), B)]
    g = zeros(2*l*t)
    K = PIPG.Zeros{Float64, 2*t*l}()
    ρx = 1.0
    ρu = 0.5
    Xes = [PIPG.InfBound{Float64, 2*l}([ρx for i=1:2*l], zeros(2*l)) for j=1:t-1]
    Us = [PIPG.InfBound{Float64, l}([ρu for i=1:l], zeros(l)) for j=1:t]
    D = PIPG.PTSpace{Float64}((PIPG.Equality{Float64, 2*l}(x0), Xes..., PIPG.Zeros{Float64, 2*l}(), Us...))
    prob = PIPG.Problem(K, D, sparse(H), sparse(P), q, g, 0.0)
	state = PIPG.State(prob, PIPG.xPIPG(1e-7, 0.95; ρ=1.55, ω=195.0))
	result, niters = PIPG.solve(prob, state)
    @test result == PIPG.OPTIMAL
    (vert_perm, edge_perm) = PIPG.sort_matrix(prob.H, 20)
    #=
    show(stdout, "text/plain", prob.H)
    println()
    show(stdout, "text/plain", prob.H[vert_perm, edge_perm])
    println()
    =#
    prex = PIPG.primal(state)
    result1 = similar(prex)
    result2 = similar(prex)
    PIPG.project!(result1, 1, PIPG.PermutedSpace(prob.d, vert_perm), prex[vert_perm])
    PIPG.project!(result2, 1, prob.d, prex)
    @test result2[vert_perm] ≈ result1
	state = PIPG.State(prob, PIPG.xPIPG(1e-7, 0.95; ρ=1.55, ω=195.0); preconditioner=PIPG.HyperSort(20))
	result, niters = PIPG.solve(prob, state)
    @test result == PIPG.OPTIMAL
end